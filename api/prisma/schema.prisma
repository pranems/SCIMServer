generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

// Phase 3: PostgreSQL provider — CITEXT for case-insensitive columns, JSONB for
// payload storage, row-level locking for concurrent writes, GIN indexes for
// filter push-down. See docs/phases/PHASE_03_POSTGRESQL_MIGRATION.md
datasource db {
  provider   = "postgresql"
  extensions = [citext, pgcrypto, pg_trgm]
}

// Multi-endpoint support: Each endpoint has isolated SCIM resources
model Endpoint {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique
  displayName String?
  description String?
  config      String?  // JSON configuration for endpoint-specific settings
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @db.Timestamptz
  updatedAt   DateTime @updatedAt     @db.Timestamptz

  logs    RequestLog[]

  // Phase 2: Unified resource relation
  resources ScimResource[]

  @@index([active])
}

model RequestLog {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  endpointId       String?  @db.Uuid
  method           String
  url              String
  status           Int?
  durationMs       Int?
  requestHeaders   String
  requestBody      String?
  responseHeaders  String?
  responseBody     String?
  errorMessage     String?
  errorStack       String?
  identifier       String?
  createdAt        DateTime @default(now()) @db.Timestamptz

  endpoint Endpoint? @relation(fields: [endpointId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([method])
  @@index([status])
  @@index([endpointId])
}

// ═══════════════════════════════════════════════════════════════════════════════
// Phase 2 → Phase 3 — Unified scim_resource table (PostgreSQL-native)
//
// Polymorphic table: resourceType discriminator ("User" / "Group") determines
// which columns are populated. CITEXT on userName/displayName eliminates the
// need for helper lowercase columns. JSONB payload enables GIN-indexed queries.
// ═══════════════════════════════════════════════════════════════════════════════

model ScimResource {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  endpointId       String   @db.Uuid
  resourceType     String   @db.VarChar(50)
  scimId           String   @db.Uuid
  externalId       String?  @db.VarChar(255)
  userName         String?  @db.Citext        // CITEXT — case-insensitive natively (Phase 3)
  displayName      String?  @db.Citext        // CITEXT — case-insensitive natively (Phase 3)
  active           Boolean  @default(true)
  payload          Json                        // JSONB — replaces rawPayload String (Phase 3)
  version          Int      @default(1)
  meta             String?
  createdAt        DateTime @default(now()) @db.Timestamptz
  updatedAt        DateTime @updatedAt     @db.Timestamptz

  endpoint         Endpoint         @relation(fields: [endpointId], references: [id], onDelete: Cascade)
  membersAsGroup   ResourceMember[] @relation("GroupMembers")
  membersAsMember  ResourceMember[] @relation("MemberResources")

  // Composite unique constraints
  @@unique([endpointId, scimId])
  @@unique([endpointId, userName])                 // CITEXT handles case-insensitive uniqueness
  @@unique([endpointId, displayName])              // CITEXT handles case-insensitive uniqueness
  @@unique([endpointId, resourceType, externalId]) // Scoped per type to avoid collisions
  @@index([endpointId, resourceType])
}

model ResourceMember {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupResourceId  String    @db.Uuid
  memberResourceId String?   @db.Uuid
  value            String
  type             String?
  display          String?
  createdAt        DateTime  @default(now()) @db.Timestamptz

  group  ScimResource  @relation("GroupMembers", fields: [groupResourceId], references: [id], onDelete: Cascade)
  member ScimResource? @relation("MemberResources", fields: [memberResourceId], references: [id], onDelete: SetNull)

  @@index([groupResourceId])
  @@index([memberResourceId])
}
