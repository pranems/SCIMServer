generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

// ⚠ SQLite provider — see docs/SQLITE_COMPROMISE_ANALYSIS.md for 28 documented
//   compromises (no CITEXT, no JSONB, single-writer lock, no horizontal scaling).
//   Migration target: PostgreSQL (provider = "postgresql").
datasource db {
  provider = "sqlite"
}

// SQLite connection pool and timeout configuration
// Applied via Prisma Client initialization in the code

// Multi-endpoint support: Each endpoint has isolated SCIM resources
model Endpoint {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String?
  description String?
  config      String?  // JSON configuration for endpoint-specific settings
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users   ScimUser[]
  groups  ScimGroup[]
  logs    RequestLog[]

  @@index([active])
}

model ScimUser {
  id            String   @id @default(cuid())
  endpointId    String   // Foreign key to endpoint
  scimId        String
  externalId    String?
  userName      String   // Original casing preserved for display
  userNameLower String   // SQLite compromise: derived lowercase column for case-insensitive uniqueness (RFC 7643 §2.1).
                         // PostgreSQL: replace with @db.Citext on userName and remove this column.
  active        Boolean  @default(true)
  rawPayload    String
  meta          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  endpoint Endpoint      @relation(fields: [endpointId], references: [id], onDelete: Cascade)
  groups   GroupMember[]

  // Composite unique constraint per endpoint (case-insensitive via userNameLower)
  @@unique([endpointId, scimId])
  @@unique([endpointId, userNameLower])
  @@unique([endpointId, externalId])
  @@index([endpointId])
}

model ScimGroup {
  id               String   @id @default(cuid())
  endpointId       String   // Foreign key to endpoint
  scimId           String
  externalId       String?  // Entra ID sends externalId for groups; first-class column for uniqueness & filtering
  displayName      String
  displayNameLower String   // SQLite compromise: derived lowercase column for case-insensitive filtering (RFC 7643 §2.1).
                           // PostgreSQL: replace with @db.Citext on displayName and remove this column.
  rawPayload       String
  meta             String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  endpoint Endpoint      @relation(fields: [endpointId], references: [id], onDelete: Cascade)
  members  GroupMember[]

  // Composite unique constraint per endpoint
  @@unique([endpointId, scimId])
  @@unique([endpointId, externalId])
  @@unique([endpointId, displayNameLower])
  @@index([endpointId])
}

model GroupMember {
  id        String    @id @default(cuid())
  groupId   String
  userId    String?
  value     String
  type      String?
  display   String?
  createdAt DateTime  @default(now())

  group ScimGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  ScimUser? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([groupId])
  @@index([userId])
}

model RequestLog {
  id               String   @id @default(cuid())
  endpointId       String?  // Optional - for system-wide logs
  method           String
  url              String
  status           Int?
  durationMs       Int?
  requestHeaders   String
  requestBody      String?
  responseHeaders  String?
  responseBody     String?
  errorMessage     String?
  errorStack       String?
  identifier       String?  // Persisted lightweight identifier (userName/email/displayName/etc)
  createdAt        DateTime @default(now())

  endpoint Endpoint? @relation(fields: [endpointId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([method])
  @@index([status])
  @@index([endpointId])
}
